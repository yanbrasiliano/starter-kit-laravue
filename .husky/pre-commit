echo "ğŸ” Executando pre-commit hook..."

current_branch=$(git rev-parse --abbrev-ref HEAD)

if [ "$current_branch" = "main" ]; then
  echo "ğŸš« Branch 'main' detectada. Pulando execuÃ§Ã£o dos testes."
  exit 0
fi

staged_files=$(git diff --name-only --cached --diff-filter=d)

if [ -z "$staged_files" ]; then
  echo "ğŸš« Nenhum arquivo staged encontrado."
  exit 0
fi

# Identifica o nome do container que contÃ©m '-app'
container_name=$(docker ps --format "{{.Names}}" | grep "-app")

if [ -z "$container_name" ]; then
  echo "âŒ Nenhum container com '-app' no nome foi encontrado. Certifique-se de que ele estÃ¡ em execuÃ§Ã£o."
  exit 1
fi

run_formatter() {
  formatter="$1"
  file="$2"
  echo "âœ¨ Formatando $file com $formatter"
  docker exec -i "$container_name" $formatter "$file"
  git add "$file"
}

run_tests() {
  coverage_mode="$1"
  echo "ğŸ§ª Executando testes para a branch '$current_branch' $coverage_mode..."

  case "$coverage_mode" in
  "--no-coverage")
    docker exec -i "$container_name" php artisan test --env=testing --parallel || {
      echo "âŒ Falha nos testes. Corrija os problemas antes de commitar."
      exit 1
    }
    ;;
  "--with-coverage")
    docker exec -i "$container_name" php artisan test --env=testing --parallel \
      --log-junit=tests/coverage/results.xml \
      --coverage-clover=tests/coverage/clover.xml || {
      echo "âŒ Falha nos testes. Corrija os problemas antes de commitar."
      exit 1
    }
    git add tests/coverage/results.xml tests/coverage/clover.xml
    echo "âœ… RelatÃ³rios adicionados ao commit."
    ;;
  esac
}

for file in $staged_files; do
  case "$file" in
  *.php) run_formatter "./vendor/bin/pint" "$file" ;;
  *.js | *.vue) run_formatter "npm run lint" "$file" ;;
  esac
done

echo "ğŸ”§ Executando anÃ¡lise do PHPStan..."
docker exec -i "$container_name" ./vendor/bin/phpstan analyse

[ "$current_branch" = "hml" ] && run_tests "--no-coverage" && exit 0
[ "$current_branch" = "dev" ] && run_tests "--with-coverage" && exit 0

echo "ğŸ“‚ Branch auxiliar detectada. Executando testes com cobertura."
run_tests "--with-coverage"

echo "âœ… Pre-commit hook finalizado com sucesso!"
